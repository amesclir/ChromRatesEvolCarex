---
title: "ChromRatesEvolCarex"
author: "Marcial Escudero"
date: "7/8/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

Setting up the data set

```{r}
PPAbio <- read.csv("PPAbio.csv")
PPAbio <- PPAbio[,2:6]
colnames(PPAbio) <- c("species", "B1", "B4", "B7", "B12")
PPAbio

PPAculm <- read.csv("PPAculm.csv")
PPAculm <- PPAculm[,2:3]
colnames(PPAculm) <- c("species", "CU")
PPAculm

PPALateralInfl <- read.csv("PPALateralInfl.csv")
PPALateralInfl <- PPALateralInfl[,2:3]
colnames(PPALateralInfl) <- c("species", "LI")
PPALateralInfl

PPAdiv2n <- read.csv("PPAdiv2n.csv")
PPAdiv2n <- PPAdiv2n[,2:6]
colnames(PPAdiv2n) <- c("species", "SP", "EX", "DI", "c2n")
PPAdiv2n


PPAmorph <- merge(PPAculm, PPALateralInfl, by.x = "species", by.y= "species", all = T)
PPAmorph

dim(PPAculm)
dim(PPALateralInfl)
dim(PPAmorph)

PPAmorphbio <- merge(PPAmorph, PPAbio, by.x = "species", by.y= "species", all = T)
dim(PPAmorphbio)

PPAdata <- merge(PPAmorphbio, PPAdiv2n, by.x = "species", by.y= "species", all = T)
dim(PPAdata)


```

Starting analyses with phylopath

```{r}

library(ape)
my_tree <- read.tree('Carex2n.tree') # For Newick format trees

my_data <- PPAdata
rownames(my_data) <- my_data$species

#my_tree$tip.label # Check the tip labels of your tree
#rownames(my_data) <- gsub(' ', '_', my_data$species_name_with_spaces)

library(phylopath)

models <- define_model_set(
  null = c(),
  direct  = c(DI ~ c2n),
  indirectmorph = c(CU ~ c2n,LI ~ c2n),
  bothmorph = c(DI ~ c2n, CU ~ c2n ,  LI ~ c2n),
  biodirect  = c(DI ~ c2n, c2n ~ B4),
  bioindirectmorph = c(CU ~ c2n ,  LI ~ c2n, c2n ~ B4),
  biobothmorph = c(DI ~ c2n, CU ~ c2n ,  LI ~ c2n, c2n ~ B4),
  .common = c(DI ~ B4, DI ~ CU + LI)
)


models$direct

plot(models$direct)

plot_model_set(models)

result <- phylo_path(models, data = my_data, tree = my_tree, model = 'lambda', na.rm = TRUE)

result

(s <- summary(result))

plot(s)

(best_model <- best(result))


plot(best_model)

average_model <- average(result)
average_model
plot(average_model, algorithm = 'mds', curvature = 0.1) # increase the curvature to avoid overlapping edges

average_model_full <- average(result, avg_method = "full")
plot(average_model_full, algorithm = 'mds', curvature = 0.1)



models2 <- define_model_set(
  null = c(),
  nmdirect  = c(DI ~ c2n),
  nmindirectmorph = c(CU ~ c2n,LI ~ c2n),
  nmbothmorph = c(DI ~ c2n, CU ~ c2n ,  LI ~ c2n),
  nmbiodirect  = c(DI ~ c2n, c2n ~ B4),
  nmbioindirectmorph = c(CU ~ c2n ,  LI ~ c2n, c2n ~ B4),
  nmbiobothmorph = c(DI ~ c2n, CU ~ c2n ,  LI ~ c2n, c2n ~ B4),
  direct  = c(DI ~ c2n,DI ~ CU + LI),
  indirectmorph = c(CU ~ c2n,LI ~ c2n,DI ~ CU + LI),
  bothmorph = c(DI ~ c2n, CU ~ c2n ,  LI ~ c2n,DI ~ CU + LI),
  biodirect  = c(DI ~ c2n, c2n ~ B4,DI ~ CU + LI),
  bioindirectmorph = c(CU ~ c2n ,  LI ~ c2n, c2n ~ B4,DI ~ CU + LI),
  biobothmorph = c(DI ~ c2n, CU ~ c2n ,  LI ~ c2n, c2n ~ B4,DI ~ CU + LI),
  .common = c(DI ~ B4)
  
)


models2$direct

plot(models2$direct)

plot_model_set(models2)

result2 <- phylo_path(models2, data = my_data, tree = my_tree, model = 'lambda', na.rm = TRUE)

result2

(s2 <- summary(result2))

plot(s2)

(best_model2 <- best(result2))


plot(best_model2)

average_model2 <- average(result2)
average_model2
plot(average_model2, algorithm = 'mds', curvature = 0.2) # increase the curvature to avoid overlapping edges

average_model_full2 <- average(result2, avg_method = "full")
plot(average_model_full2, algorithm = 'mds', curvature = 0.2)

```

Let's create shuffle trees for the permutation analyses

```{r}

library(picante)
my_tree

my_trees <- list()

for (i in 1:100) my_trees[[i]] <- tipShuffle(my_tree)

my_trees

for (i in 1:100) write.tree(my_trees[[i]], paste0("./trees/my_tree", paste(i), ".tree"))

```


Let's get the matrices

```{r}

branchmatrix <- read.csv(file= "branch_matrix.csv")
branchmatrix
colnames(branchmatrix) <- c("div", "spe", "ext", "r2n")

branchmatrixsim <- matrix(0, 1508, 100)
for (i in 1:100) branchmatrixsim[,i] <- read.csv(paste0("./branchmatrix/branch_matrix", paste(i), ".csv"))[,2]

branchmatrixdef <- cbind(branchmatrix,branchmatrixsim)
dim(branchmatrixdef)

results <- list()
for (i in 5:105) results[[i-4]] <- summary(lm(branchmatrixdef[,1] ~ branchmatrixdef[,i]))

pvalues <- vector()
for (i in 1:100) pvalues[i] <- results[[i]]$coefficients[2,4]
pvalues

rsquareds <- vector()
for (i in 1:100) rsquareds[i] <- results[[i]]$r.squared
rsquareds

sort(pvalues)
summary(lm(branchmatrixdef[,1] ~ branchmatrixdef[,4]))$coefficients[2,4]
sort(rsquareds)
summary(lm(branchmatrixdef[,1] ~ branchmatrixdef[,4]))$r.squared

```

